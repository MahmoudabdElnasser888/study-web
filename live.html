<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Study With Me</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    #login, #session { max-width:600px; margin:auto; padding:20px; background:#fff; border-radius:10px; }
    #chat { border:1px solid #ccc; height:200px; overflow-y:auto; padding:10px; margin:10px 0; }
    .student { display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #ddd; }
    .admin { color:red; font-weight:bold; }
  </style>
</head>
<body>

<div id="login">
  <h2>ğŸ“š Study With Me</h2>
  <input type="text" id="name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ">
  <input type="password" id="code" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (222/1212)">
  <button id="joinBtn">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="session" style="display:none;">
  <h2 id="roleTitle"></h2>
  <p>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="studentCount">0</span></p>
  <div id="students"></div>

  <div id="chat"></div>

  <div id="adminTools" style="display:none;">
    <input type="text" id="adminMsg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø·Ù„Ø§Ø¨">
    <button id="sendMsg">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDnXtTg9iLLm_b9zyKBxr0v8aGhXJuR3WE",
    authDomain: "my-web-c23de.firebaseapp.com",
    projectId: "my-web-c23de",
    storageBucket: "my-web-c23de.appspot.com",
    messagingSenderId: "846339445873",
    appId: "1:846339445873:web:fc0427a7ad77eceda837d0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let userName = "";
  let userRole = "student"; // or admin
  let userDocId = "";

  // Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
  document.getElementById("joinBtn").addEventListener("click", async () => {
    userName = document.getElementById("name").value.trim();
    const code = document.getElementById("code").value.trim();

    if (!userName || !code) {
      alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ§Ù„ÙƒÙˆØ¯");
      return;
    }

    if (code === "1212") {
      userRole = "admin";
      document.getElementById("roleTitle").innerText = "âœ… Ø§Ù†Øª Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ø´Ø±Ù";
      document.getElementById("adminTools").style.display = "block";
    } else if (code === "222") {
      userRole = "student";
      document.getElementById("roleTitle").innerText = "ğŸ“ Ø§Ù†Øª Ø§Ù„Ø¢Ù† Ø·Ø§Ù„Ø¨";
    } else {
      alert("ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­");
      return;
    }

    // Ø£Ø®ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ø¸Ù‡Ø± Ø§Ù„Ø¬Ù„Ø³Ø©
    document.getElementById("login").style.display = "none";
    document.getElementById("session").style.display = "block";

    // Ø£Ø¶ÙŠÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
    const docRef = await addDoc(collection(db, "session", "room1", "users"), {
      name: userName,
      role: userRole,
      requestExit: false
    });
    userDocId = docRef.id;

    // Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
    onSnapshot(collection(db, "session", "room1", "users"), (snapshot) => {
      const studentsDiv = document.getElementById("students");
      studentsDiv.innerHTML = "";
      let count = 0;

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.role === "student") count++;

        const div = document.createElement("div");
        div.className = "student";
        div.innerHTML = `
          <span>${data.name} ${data.role === "admin" ? "(Ù…Ø´Ø±Ù)" : ""}</span>
          ${userRole === "admin" && data.role === "student" ? 
            `<button onclick="approveExit('${docSnap.id}')">Ø®Ø±ÙˆØ¬</button>` : ""}
        `;
        studentsDiv.appendChild(div);
      });

      document.getElementById("studentCount").innerText = count;
    });

    // Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø´Ø§Øª
    onSnapshot(collection(db, "session", "room1", "messages"), (snapshot) => {
      const chatBox = document.getElementById("chat");
      chatBox.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        chatBox.innerHTML += `<p class="${data.role === 'admin' ? 'admin' : ''}">${data.name}: ${data.text}</p>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  });

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù
  document.getElementById("sendMsg").addEventListener("click", async () => {
    const msg = document.getElementById("adminMsg").value.trim();
    if (!msg) return;
    await addDoc(collection(db, "session", "room1", "messages"), {
      name: userName,
      role: userRole,
      text: msg,
      timestamp: Date.now()
    });
    document.getElementById("adminMsg").value = "";
  });

  // Ø®Ø±ÙˆØ¬ Ø·Ø§Ù„Ø¨ Ø¨Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø´Ø±Ù
  window.approveExit = async (id) => {
    await deleteDoc(doc(db, "session", "room1", "users", id));
  };

  // Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø¥Ø°Ù† (Ù„Ùˆ Ù‚ÙÙ„ Ø§Ù„ØµÙØ­Ø© ÙŠØªÙ… Ù…Ø³Ø­Ù‡ Ø¨Ø³ Ù„Ùˆ Admin Ù…Ø§ ÙŠØªØ£Ø«Ø±Ø´)
  window.addEventListener("beforeunload", async (e) => {
    if (userRole === "student" && userDocId) {
      e.preventDefault();
      e.returnValue = "Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø¥Ø°Ù† Ø§Ù„Ù…Ø´Ø±Ù!";
      return "Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø¥Ø°Ù† Ø§Ù„Ù…Ø´Ø±Ù!";
    }
  });
</script>
</body>
</html>
