<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Study With Me</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    #login, #session { max-width:600px; margin:auto; padding:20px; background:#fff; border-radius:10px; }
    #chat { border:1px solid #ccc; height:200px; overflow-y:auto; padding:10px; margin:10px 0; }
    .student { display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #ddd; }
    .admin { color:red; font-weight:bold; }
  </style>
</head>
<body>

<div id="login">
  <h2>📚 Study With Me</h2>
  <input type="text" id="name" placeholder="اكتب اسمك">
  <input type="password" id="code" placeholder="ادخل الكود (222/1212)">
  <button id="joinBtn">دخول</button>
</div>

<div id="session" style="display:none;">
  <h2 id="roleTitle"></h2>
  <p>👥 عدد الطلاب: <span id="studentCount">0</span></p>
  <div id="students"></div>

  <div id="chat"></div>

  <div id="adminTools" style="display:none;">
    <input type="text" id="adminMsg" placeholder="اكتب رسالة للطلاب">
    <button id="sendMsg">إرسال</button>
  </div>
</div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDnXtTg9iLLm_b9zyKBxr0v8aGhXJuR3WE",
    authDomain: "my-web-c23de.firebaseapp.com",
    projectId: "my-web-c23de",
    storageBucket: "my-web-c23de.appspot.com",
    messagingSenderId: "846339445873",
    appId: "1:846339445873:web:fc0427a7ad77eceda837d0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let userName = "";
  let userRole = "student"; // or admin
  let userDocId = "";

  // زر الدخول
  document.getElementById("joinBtn").addEventListener("click", async () => {
    userName = document.getElementById("name").value.trim();
    const code = document.getElementById("code").value.trim();

    if (!userName || !code) {
      alert("من فضلك اكتب اسمك والكود");
      return;
    }

    if (code === "1212") {
      userRole = "admin";
      document.getElementById("roleTitle").innerText = "✅ انت الآن المشرف";
      document.getElementById("adminTools").style.display = "block";
    } else if (code === "222") {
      userRole = "student";
      document.getElementById("roleTitle").innerText = "🎓 انت الآن طالب";
    } else {
      alert("كود غير صحيح");
      return;
    }

    // أخفي صفحة الدخول واظهر الجلسة
    document.getElementById("login").style.display = "none";
    document.getElementById("session").style.display = "block";

    // أضيف المستخدم في Firestore
    const docRef = await addDoc(collection(db, "session", "room1", "users"), {
      name: userName,
      role: userRole,
      requestExit: false
    });
    userDocId = docRef.id;

    // متابعة الطلاب
    onSnapshot(collection(db, "session", "room1", "users"), (snapshot) => {
      const studentsDiv = document.getElementById("students");
      studentsDiv.innerHTML = "";
      let count = 0;

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.role === "student") count++;

        const div = document.createElement("div");
        div.className = "student";
        div.innerHTML = `
          <span>${data.name} ${data.role === "admin" ? "(مشرف)" : ""}</span>
          ${userRole === "admin" && data.role === "student" ? 
            `<button onclick="approveExit('${docSnap.id}')">خروج</button>` : ""}
        `;
        studentsDiv.appendChild(div);
      });

      document.getElementById("studentCount").innerText = count;
    });

    // متابعة الشات
    onSnapshot(collection(db, "session", "room1", "messages"), (snapshot) => {
      const chatBox = document.getElementById("chat");
      chatBox.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        chatBox.innerHTML += `<p class="${data.role === 'admin' ? 'admin' : ''}">${data.name}: ${data.text}</p>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  });

  // إرسال رسالة من المشرف
  document.getElementById("sendMsg").addEventListener("click", async () => {
    const msg = document.getElementById("adminMsg").value.trim();
    if (!msg) return;
    await addDoc(collection(db, "session", "room1", "messages"), {
      name: userName,
      role: userRole,
      text: msg,
      timestamp: Date.now()
    });
    document.getElementById("adminMsg").value = "";
  });

  // خروج طالب بموافقة المشرف
  window.approveExit = async (id) => {
    await deleteDoc(doc(db, "session", "room1", "users", id));
  };

  // منع الخروج بدون إذن (لو قفل الصفحة يتم مسحه بس لو Admin ما يتأثرش)
  window.addEventListener("beforeunload", async (e) => {
    if (userRole === "student" && userDocId) {
      e.preventDefault();
      e.returnValue = "ممنوع الخروج بدون إذن المشرف!";
      return "ممنوع الخروج بدون إذن المشرف!";
    }
  });
</script>
</body>
</html>
