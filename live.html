<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>امتحان مباشر</title>
  <script type="module">
    // ✅ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBsKneiM3AcbpWUzJtdZ-yDtp__8JbCN7Y",
      authDomain: "codeaccessproject-82614.firebaseapp.com",
      projectId: "codeaccessproject-82614",
      storageBucket: "codeaccessproject-82614.firebasestorage.app",
      messagingSenderId: "522691348426",
      appId: "1:522691348426:web:76f17fb8ec91b3ca47f133",
      measurementId: "G-W46X7GM6CS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    document.addEventListener("DOMContentLoaded", () => {
      const loginBox = document.getElementById("login-box");
      const examBox = document.getElementById("exam-box");
      const codeInput = document.getElementById("code-input");
      const emailInput = document.getElementById("email-input");
      const loginBtn = document.getElementById("login-btn");
      const submitBtn = document.getElementById("submit-btn");
      const studentInfo = document.getElementById("student-info");
      const questionsContainer = document.getElementById("questions-container");

      // 📝 الأسئلة (صورة + اختيارات)
      const questions = [
        {
          img: "q1.jpg",
          options: ["الإجابة 1", "الإجابة 2", "الإجابة 3", "الإجابة 4"]
        },
        {
          img: "q2.jpg",
          options: ["A", "B", "C", "D"]
        }
      ];

      loginBtn.addEventListener("click", async () => {
        const code = codeInput.value.trim();
        const email = emailInput.value.trim();
        if (!code || !email) {
          alert("⚠️ أدخل الكود والبريد الإلكتروني");
          return;
        }

        const userRef = doc(db, "users", code);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          alert("❌ الكود غير صحيح");
          return;
        }

        const data = userSnap.data();
        if (data.used === true) {
          alert("⚠️ الكود تم استخدامه من قبل");
          return;
        }

        // ✅ لو الكود صحيح ومش مستخدم → يحدث used ويدخل الامتحان
        await updateDoc(userRef, { used: true, email: email });

        studentInfo.textContent = `الكود: ${code} | ${email}`;
        loginBox.classList.add("hidden");
        examBox.classList.remove("hidden");

        renderQuestions();
      });

      // عرض كل الأسئلة
      function renderQuestions() {
        questionsContainer.innerHTML = "";
        questions.forEach((q, index) => {
          const qDiv = document.createElement("div");
          qDiv.className = "question";

          const img = document.createElement("img");
          img.src = q.img;
          img.alt = `سؤال ${index + 1}`;

          const optionsDiv = document.createElement("div");
          optionsDiv.className = "answers";

          q.options.forEach((opt, optIndex) => {
            const id = `q${index}-opt${optIndex}`;
            const label = document.createElement("label");
            label.innerHTML = `<input type="radio" name="q${index}" value="${opt}"> ${opt}`;
            optionsDiv.appendChild(label);
          });

          qDiv.appendChild(img);
          qDiv.appendChild(optionsDiv);
          questionsContainer.appendChild(qDiv);
        });
      }

      // إرسال الإجابات
      submitBtn.addEventListener("click", () => {
        const answers = [];
        let allAnswered = true;

        questions.forEach((_, index) => {
          const selected = document.querySelector(`input[name="q${index}"]:checked`);
          if (selected) {
            answers.push(selected.value);
          } else {
            allAnswered = false;
          }
        });

        if (!allAnswered) {
          alert("⚠️ جاوب على كل الأسئلة قبل الإرسال");
          return;
        }

        console.log("الإجابات:", answers);
        alert("✅ تم إرسال إجابتك بنجاح");
        // هنا تقدر تبعت الإجابات لـ Firestore لو عايز
      });
    });
  </script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #login-box, #exam-box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 450px;
      width: 100%;
      text-align: center;
    }
    .hidden { display: none; }
    img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .answers {
      text-align: right;
      margin-bottom: 15px;
    }
    .answers label {
      display: block;
      margin: 5px 0;
      cursor: pointer;
    }
    button {
      padding: 10px 15px;
      background: black;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #333;
    }
    .question {
      margin-bottom: 25px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 15px;
    }
  </style>
</head>
<body>

  <!-- تسجيل الدخول -->
  <div id="login-box">
    <h2>دخول الامتحان</h2>
    <input type="text" id="code-input" placeholder="أدخل الكود"><br><br>
    <input type="email" id="email-input" placeholder="أدخل بريدك الإلكتروني"><br><br>
    <button id="login-btn">دخول</button>
  </div>

  <!-- الامتحان -->
  <div id="exam-box" class="hidden">
    <div id="student-info" style="margin-bottom:10px;font-weight:bold;"></div>

    <div id="questions-container"></div>

    <button id="submit-btn">إرسال الإجابات</button>
  </div>

</body>
</html>
