<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StudyWeb — بدء</title>

  <!-- خطوط -->
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <!-- أيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --bg:#01021a;
      --neon-blue: #00e6ff;
      --neon-purple: #9b4dff;
      --neon-accent: linear-gradient(90deg,#00e6ff,#9b4dff);
      --glass: rgba(255,255,255,0.03);
      --muted: rgba(255,255,255,0.75);
      --card-bg: rgba(255,255,255,0.02);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Cairo',system-ui,Arial; background:var(--bg); color:#fff; direction:rtl; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
    /* خفيف Fade-in للصفحة */
    body { opacity:0; transform: translateY(6px); transition: opacity .5s ease, transform .45s ease; }
    body.show{ opacity:1; transform: translateY(0); }

    /* ===== animated neon grid background (خفيف ومُحسّن) ===== */
    .bg-canvas{
      position:fixed; inset:0; z-index:-10; pointer-events:none; overflow:hidden;
      background: radial-gradient(circle at 10% 20%, rgba(0,230,255,0.02), transparent 10%),
                  radial-gradient(circle at 80% 80%, rgba(155,77,255,0.02), transparent 12%),
                  #000014;
    }

    .neon-grid {
      position:absolute; inset:-20%;
      background-image:
        linear-gradient(0deg, rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 90px 90px, 90px 90px;
      mix-blend-mode:screen;
      filter:blur(12px) saturate(120%);
      opacity:0.11;
      animation: gridMove 26s linear infinite;
    }
    @keyframes gridMove {
      0% { transform: translate3d(0,0,0) rotate(0); }
      50% { transform: translate3d(-40px,-20px,0) rotate(2deg); }
      100% { transform: translate3d(0,0,0) rotate(0); }
    }

    .glow-strip{
      position:absolute; left:-20%; top:10%; width:140%; height:60%;
      background: radial-gradient(30% 40% at 10% 10%, rgba(0,230,255,0.06), transparent 12%),
                  radial-gradient(40% 60% at 90% 90%, rgba(155,77,255,0.05), transparent 12%);
      filter: blur(36px) saturate(120%);
      transform: translateZ(0);
      animation: glowMove 28s linear infinite;
      opacity:0.24;
    }
    @keyframes glowMove { 0%{transform: translateX(0)} 50%{transform: translateX(-40px)} 100%{transform: translateX(0)} }

    .particle {
      position:absolute;border-radius:50%;
      background: radial-gradient(circle, rgba(255,255,255,0.9), rgba(255,255,255,0.05));
      filter: blur(5px); opacity:0.06;
      animation: floatY linear infinite;
    }
    @keyframes floatY { 0%{transform: translateY(0)} 50%{transform: translateY(-26px)} 100%{transform: translateY(0)} }

    /* ===== header ===== */
    header{ position:sticky; top:0; z-index:40; padding:12px 18px; background: linear-gradient(180deg, rgba(2,4,12,0.55), rgba(2,4,12,0.25)); border-bottom:1px solid rgba(255,255,255,0.03); backdrop-filter: blur(6px) }
    .header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--neon-blue),var(--neon-purple));
      display:inline-flex;align-items:center;justify-content:center;color:#001;font-weight:900;font-family:'Audiowide',sans-serif;box-shadow:0 18px 60px rgba(124,58,237,0.06)
    }
    .site-title{font-weight:900;color:var(--neon-blue);font-family:'Audiowide',sans-serif}
    .header-right{display:flex;align-items:center;gap:12px}
    .rased{background:linear-gradient(90deg,#ff6f61,#ff3b2e);padding:8px 14px;border-radius:999px;color:#fff;font-weight:800;text-decoration:none;box-shadow:0 12px 38px rgba(255,111,97,0.06)}
    .sub-status{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:8px 12px;border-radius:10px; min-width:180px; color:var(--muted); font-weight:700; text-align:center}
    .privacy-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--muted);font-weight:700;text-decoration:none}

    /* ===== hero ===== */
    .hero{min-height:62vh;display:flex;align-items:center;justify-content:center;padding:48px 16px}
    .hero-inner{max-width:1100px;width:100%;display:flex;gap:28px;align-items:center;justify-content:space-between}
    .hero-left{flex:1}
    .hero h1{margin:0;font-size:2.0rem;color:var(--neon-blue);font-family:'Audiowide',sans-serif;text-shadow:0 18px 60px rgba(0,230,255,0.04)}
    .hero p{color:var(--muted);margin-top:10px}
    .start-btn{margin-top:18px;background:linear-gradient(90deg,var(--neon-blue),var(--neon-purple));border:none;padding:14px 28px;border-radius:12px;font-weight:900;color:#001;cursor:pointer;box-shadow:0 26px 80px rgba(124,58,237,0.08); transition: transform .14s, box-shadow .14s}
    .start-btn:active{transform:translateY(2px)} 
    .start-btn:hover{box-shadow:0 40px 120px rgba(124,58,237,0.12)}

    .hero-right{width:360px;min-width:220px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .stat{font-weight:900;color:var(--neon-purple);font-size:1.4rem}
    .stat-label{color:var(--muted);font-size:0.9rem;margin-top:6px}
    .stats-row{display:flex;gap:12px;align-items:center;justify-content:space-between}

    /* ===== content grid ===== */
    .content{max-width:1100px;margin:0 auto;padding:28px 16px;display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media (max-width:1024px){ .content{grid-template-columns:repeat(2,1fr)} .hero-inner{flex-direction:column;align-items:center} .hero-right{width:100%} }
    @media (max-width:640px){ .content{grid-template-columns:1fr;padding:18px} .hero h1{font-size:1.6rem} }

    .card{background:var(--card-bg);border-radius:12px;padding:18px;display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,0.03);transition:transform .22s,box-shadow .22s}
    .card:hover{transform:translateY(-8px);box-shadow:0 26px 80px rgba(0,0,0,0.45)}
    .card i{font-size:34px;color:goldenrod;width:64px;height:64px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))}
    .card h3{margin:0;font-size:1.05rem}
    .card p{margin:6px 0;color:var(--muted);font-size:0.95rem}
    .enter-btn{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--neon-purple),var(--neon-blue));color:#001;font-weight:800;cursor:pointer}

    .card.locked{position:relative;opacity:0.95;filter:saturate(.9)}
    .lock-overlay{position:absolute;top:12px;left:12px;background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:8px;display:flex;align-items:center;gap:8px;color:#fff;font-weight:700;font-size:13px}

    /* footer */
    footer{margin-top:30px;padding:20px 10px;color:var(--muted); position:relative}
    .footer-inner{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:10px}
    .socials{display:flex;gap:12px}
    .socials a{width:44px;height:44px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:#fff;text-decoration:none}
    .socials .telegram{background:#0088cc}
    .socials .facebook{background:#1877f2}
    .socials .whatsapp{background:#25d366}
    .hidden-link{position:absolute;right:12px;bottom:10px;font-size:12px;color:rgba(255,255,255,0.12);text-decoration:none}
    .hidden-link:hover{color:var(--muted)}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2000}
    .modal{width:31%;max-width:540px;background:#fff;color:#111;border-radius:12px;padding:12px;box-shadow:0 30px 80px rgba(0,0,0,0.5)}
    .package{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;border:1px solid #eee;margin-bottom:10px;cursor:pointer}
    .package.selected{border-color:var(--neon-purple);box-shadow:0 12px 40px rgba(155,77,255,0.06)}
    .modal .modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
    .muted-small{color:var(--muted);font-size:13px}

    /* small tweaks */
    a { color: inherit; }

    /* responsive tweaks for modal and hero stats */
    @media (max-width:720px) {
      .modal{ width:86%; }
      .hero-right{ display:none; } /* hide right panel on small screens to save space */
      .content { grid-template-columns: 1fr 1fr; gap:12px; }
      @media (max-width:420px) { .content { grid-template-columns: 1fr; } }
    }
  </style>
</head>
<body>
  <!-- background layers -->
  <div class="bg-canvas" aria-hidden="true">
    <div class="neon-grid" aria-hidden="true"></div>
    <div class="glow-strip" aria-hidden="true"></div>

    <!-- floating particles -->
    <div class="particle" style="width:8px;height:8px;left:8%;top:18%;animation-duration:20s"></div>
    <div class="particle" style="width:12px;height:12px;left:22%;top:36%;animation-duration:26s"></div>
    <div class="particle" style="width:10px;height:10px;left:72%;top:22%;animation-duration:24s"></div>
    <div class="particle" style="width:14px;height:14px;left:60%;top:70%;animation-duration:28s"></div>
  </div>

  <!-- header -->
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden>TF</div>
        <div>
          <div class="site-title">The feature</div>
          <div class="muted-small">منصة التعلم والمكافآت</div>
        </div>
      </div>

      <div class="header-right">
        <a class="rased" href="pay.html">الرصيد: <span id="balance">0</span> ج</a>
        <div id="subscription-status" class="sub-status">غير مسجل</div>
        <a class="privacy-btn" href="go.html">كيفيه الاستخدام</a>
      </div>
    </div>
  </header>

  <!-- hero -->
  <section class="hero" aria-labelledby="heroTitle">
    <div class="hero-inner">
      <div class="hero-left">
        <h1 id="heroTitle">أهلاً بك — علّق، تعلّم، وافز</h1>
        <p>منصة تعليمية متكاملة — اختبر مهاراتك، شارك بالمجتمع، وفز بجوائز.</p>
        <div style="margin-top:18px">
          <button class="start-btn" id="startBtn">ابدأ الآن</button>
        </div>
      </div>

    
    </div>
  </section>

  <!-- main grid -->
  <main class="content" role="main">

    <article id="todo" class="card">
      <i class="fas fa-list-check"></i>
      <div>
        <h3>تسهيل الدراسة</h3>
        <p>العديد من التطبيقات في مكان واحد لتسهيل الدراسه عليك</p>
        <div style="margin-top:10px"><a href="easy.html"><button class="enter-btn">دخول</button></a></div>
      </div>
    </article>

    <article id="learning" class="card locked">
      <i class="fas fa-book"></i>
      <div>
        <h3>المحتوى التعليمي</h3>
        <p>دروس ومناهج مرتّبة — متاحة للمشتركين.</p>
        <div style="margin-top:10px"><button id="learning-enter" class="enter-btn">دخول</button></div>
      </div>
      <div class="lock-overlay" id="learning-overlay"><i class="fas fa-lock"></i> مُقفل — اشترك</div>
    </article>

    <article id="community" class="card">
      <i class="fas fa-users"></i>
      <div>
        <h3>المجتمع</h3>
        <p>انضم للنقاشات وشارك الموارد.</p>
        <div style="margin-top:10px"><a href="community.html"><button class="enter-btn">دخول</button></a></div>
      </div>
    </article>

    <article id="top3" class="card">
      <i class="fa-solid fa-trophy"></i>
      <div>
        <h3>Top 3</h3>
        <p>نافس لتحل في المراكز الأولى.</p>
        <div style="margin-top:10px"><a href="dash.html"><button class="enter-btn">دخول</button></a></div>
      </div>
    </article>

    <article id="feedback" class="card">
      <i class="fa-solid fa-box"></i>
      <div>
        <h3>صندوق الملاحظات</h3>
        <p>أرسل لنا رأيك لنطور المنصة.</p>
        <div style="margin-top:10px"><a href="feedback.html"><button class="enter-btn">دخول</button></a></div>
      </div>
    </article>

    <article id="championship" class="card locked">
      <i class="fa-solid fa-trophy"></i>
      <div>
        <h3>البطولة</h3>
        <p>انضم للبطولة وتحدّ الزملاء.</p>
        <div style="margin-top:10px"><a href="rules.html"><button class="enter-btn">تفاصيل</button></a></div>
      </div>
    </article>

    <article id="summ" class="card">
      <i class="fas fa-file-alt"></i>
      <div>
        <h3>التلخيصات</h3>
        <p>أرسل وادير ملخصاتك بسهولة.</p>
        <div style="margin-top:10px"><a href="try.html"><button class="enter-btn">دخول</button></a></div>
      </div>
    </article>

    <article id="prize" class="card">
      <i class="fa-solid fa-money-check-dollar"></i>
      <div>
        <h3>استلام الجوائز</h3>
        <p>اطلب جائزة أو تابع حالة استلامك.</p>
        <div style="margin-top:10px"><a href="prize.html"><button class="enter-btn">دخول</button></a></div>
      </div>
    </article>

    <article class="card locked">
      <i class="fa-solid fa-bag-shopping"></i>
      <div>
        <h3>Our Brand</h3>
        <p>قريباً — منتجات ومزايا للطلاب.</p>
        <div style="margin-top:10px"><button class="enter-btn" disabled>قريباً</button></div>
      </div>
    </article>

    <article class="card locked">
      <i class="fa-solid fa-handshake-angle"></i>
      <div>
        <h3>عروض قادمة</h3>
        <p>صفقات خاصة.</p>
        <div style="margin-top:10px"><button class="enter-btn" disabled>قريباً</button></div>
      </div>
    </article>

  </main>

  <!-- footer -->
  <footer>
    <div class="footer-inner">
      <div class="socials" role="navigation" aria-label="social links">
        <a class="telegram" href="https://t.me/studyweb1919" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
        <a class="whatsapp" href="https://wa.me/201121101238" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
      </div>
      <div class="muted-small">© 2025 StudyWeb — جميع الحقوق محفوظة</div>

      <!-- admin (hidden) -->
      <a href="the-admin.html" id="admin-hidden" class="hidden-link" title="Admin (hidden)">404</a>
    </div>
  </footer>

  <!-- Modal (subscription) -->
  <div class="modal-backdrop" id="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">اشترك في المحتوى</h3>
      <p class="muted-small">اختر باقة — سيتم خصم المبلغ من رصيد الحساب داخل التطبيق.</p>

      <div id="packageList" style="margin-top:12px">
        <div class="package" data-amount="20" data-days="7" id="pkg20">
          <div>
            <strong>باقة أسبوعي</strong>
            <div class="muted-small">صلاحية: 7 أيام</div>
          </div>
          <div style="font-weight:800; color:var(--neon-purple)">20 ج</div>
        </div>

        <div class="package" data-amount="35" data-days="14" id="pkg35">
          <div>
            <strong>باقة أسبوعين</strong>
            <div class="muted-small">صلاحية: 14 يوم</div>
          </div>
          <div style="font-weight:800; color:var(--neon-purple)">35 ج</div>
        </div>

        <div class="package" data-amount="50" data-days="30" id="pkg50">
          <div>
            <strong>باقة شهر</strong>
            <div class="muted-small">صلاحية: 30 يوم</div>
          </div>
          <div style="font-weight:800; color:var(--neon-purple)">50 ج</div>
        </div>
      </div>

      <div id="modal-msg" class="muted-small" style="margin-top:8px;color:#c33"></div>

      <div class="modal-footer">
        <button class="btn ghost" id="modal-cancel">إلغاء</button>
        <button class="btn primary" id="modal-confirm">ادفع</button>
      </div>
    </div>
  </div>

  <!-- Firebase (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // ---------- Firebase config (yours) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDnXtTg9iLLm_b9zyKBxr0v8aGhXJuR3WE",
      authDomain: "my-web-c23de.firebaseapp.com",
      projectId: "my-web-c23de",
      storageBucket: "my-web-c23de.appspot.com",
      messagingSenderId: "846339445873",
      appId: "1:846339445873:web:fc0427a7ad77eceda837d0",
      measurementId: "G-3SE0GBRS8C"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ---------- UI refs (guarded) ----------
    const balanceSpan = document.getElementById('balance');
    const subStatus = document.getElementById('subscription-status');
    const learningItem = document.getElementById('learning');
    const learningEnterBtn = document.getElementById('learning-enter');
    const learningOverlay = document.getElementById('learning-overlay');

    const modalBackdrop = document.getElementById('modal-backdrop');
    const packageList = document.getElementById('packageList');
    const modalMsg = document.getElementById('modal-msg');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');

    // safe existence checks for elements that might be missing
    function el(id) { return document.getElementById(id); }

    let currentUser = null;
    let selectedPackageAmount = null;
    let selectedPackageDays = null;
    let userDocUnsub = null;
    let localUserData = {};
    let countdownInterval = null;
    let handledExpiredForThisSession = false;
    let modalMode = 'purchase'; // 'purchase' or 'goto' (when subscription active)

    // helper: compute remaining time parts
    function getRemainingParts(expiresMs){
      const now = Date.now();
      let diff = Math.max(0, expiresMs - now);
      const days = Math.floor(diff / (24*60*60*1000)); diff -= days * 24*60*60*1000;
      const hours = Math.floor(diff / (60*60*1000)); diff -= hours * 60*60*1000;
      const mins = Math.floor(diff / (60*1000)); diff -= mins * 60*1000;
      const secs = Math.floor(diff / 1000);
      return { days, hours, mins, secs };
    }

    // show modal (mode depends on subscription status)
    function showModal() {
      if(!modalBackdrop || !packageList || !modalMsg || !modalConfirm) return;
      modalMsg.innerText = '';
      selectedPackageAmount = null;
      selectedPackageDays = null;
      modalConfirm.disabled = false;
      document.querySelectorAll('.package').forEach(el => el.classList.remove('selected'));

      // decide mode based on localUserData.subscription
      const sub = localUserData.subscription;
      const hasActive = sub && sub.active === true && sub.expiresAt;
      let stillActive = false;
      if(hasActive){
        const expiresAt = sub.expiresAt;
        const expiresMs = (expiresAt && typeof expiresAt.toMillis === 'function') ? expiresAt.toMillis() : (new Date(expiresAt).getTime());
        if(!isNaN(expiresMs) && expiresMs > Date.now()) stillActive = true;
      }

      if(stillActive){
        modalMode = 'goto';
        packageList.style.display = 'none';
        const expiresAt = sub.expiresAt;
        const expiresMs = (expiresAt && typeof expiresAt.toMillis === 'function') ? expiresAt.toMillis() : (new Date(expiresAt).getTime());
        const rem = getRemainingParts(expiresMs);
        modalMsg.style.color = '#0a7b2a';
        modalMsg.innerText = `اشتراك مفعل — باقي ${rem.days} يوم ${pad(rem.hours)}:${pad(rem.mins)}:${pad(rem.secs)}. اضغط "اذهب للمحتوى" للانتقال.`;
        modalConfirm.innerText = 'اذهب للمحتوى';
      } else {
        modalMode = 'purchase';
        packageList.style.display = 'block';
        modalMsg.style.color = '#c33';
        modalMsg.innerText = '';
        modalConfirm.innerText = 'ادفع';
      }

      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
      if(!modalBackdrop || !packageList || !modalMsg) return;
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden', 'true');
      packageList.style.display = 'block';
      modalMsg.innerText = '';
    }

    // select package (single)
    if (packageList) {
      packageList.addEventListener('click', (e) => {
        const pkg = e.target.closest('.package');
        if(!pkg) return;
        document.querySelectorAll('.package').forEach(el => el.classList.remove('selected'));
        pkg.classList.add('selected');
        selectedPackageAmount = Number(pkg.dataset.amount);
        selectedPackageDays = Number(pkg.dataset.days);
        if(modalMsg) {
          modalMsg.style.color = '#333';
          modalMsg.innerText = `سيتم خصم ${selectedPackageAmount} ج من رصيدك عند التأكيد. صلاحية: ${selectedPackageDays} يوم.`;
        }
        if(modalConfirm) modalConfirm.innerText = `ادفع ${selectedPackageAmount} ج`;
      });
    }

    if (modalCancel) modalCancel.addEventListener('click', () => { closeModal(); });

    // confirm purchase or goto content
    if (modalConfirm) modalConfirm.addEventListener('click', async () => {
      if(modalMode === 'goto') {
        closeModal();
        window.location.href = 'student.html';
        return;
      }

      if(!currentUser) {
        if(modalMsg) { modalMsg.style.color = 'red'; modalMsg.innerText = 'يجب تسجيل الدخول أولاً.'; }
        return;
      }
      if(!selectedPackageAmount || !selectedPackageDays) {
        if(modalMsg) { modalMsg.style.color = 'red'; modalMsg.innerText = 'اختر باقة أولاً.'; }
        return;
      }

      modalConfirm.disabled = true;
      const originalText = modalConfirm.innerText;
      modalConfirm.innerText = 'جاري المعالجة...';

      const uid = currentUser.uid;
      const userRef = db.collection('users').doc(uid);

      try {
        await db.runTransaction(async (tran) => {
          const doc = await tran.get(userRef);
          if(!doc.exists) throw new Error('مستخدم غير موجود.');
          const data = doc.data();
          const balance = Number(data.balance ?? 0);
          if(balance < selectedPackageAmount) throw new Error('رصيد غير كافٍ');

          // use server timestamps for reliability but set expires using client time converted to firestore.Timestamp
          const nowMs = Date.now();
          const expiresAtMs = nowMs + selectedPackageDays * 24 * 60 * 60 * 1000;
          const startsAtTs = firebase.firestore.Timestamp.fromMillis(nowMs);
          const expiresAtTs = firebase.firestore.Timestamp.fromMillis(expiresAtMs);

          const newBalance = balance - selectedPackageAmount;

          tran.update(userRef, {
            balance: newBalance,
            subscription: {
              active: true,
              boughtAt: startsAtTs,
              expiresAt: expiresAtTs,
              packageAmount: selectedPackageAmount,
              days: selectedPackageDays
            }
          });
        });

        if(modalMsg) { modalMsg.style.color = '#0a7b2a'; modalMsg.innerText = 'تم الدفع بنجاح — تم فتح المحتوى.'; }
        setTimeout(() => { closeModal(); }, 900);

      } catch (err) {
        console.error(err);
        if(modalMsg) {
          if(err && err.code === 'permission-denied') {
            modalMsg.style.color = 'red';
            modalMsg.innerText = 'فشل العملية: صلاحيات قاعدة البيانات تمنع هذا الإجراء. تأكد من قواعد Firestore أو من تسجيل الدخول الصحيح.';
          } else {
            modalMsg.style.color = 'red';
            modalMsg.innerText = 'حصل خطأ: ' + (err.message || err);
          }
        }
      } finally {
        modalConfirm.disabled = false;
        modalConfirm.innerText = originalText || 'ادفع';
      }
    });

    // update UI from user doc
    function updateUIFromUserData(data) {
      const balance = Number(data.balance ?? 0);
      if(balanceSpan) balanceSpan.innerText = Math.max(0, balance);
      const sub = data.subscription;
      const active = sub && sub.active === true && sub.expiresAt;
      localUserData = { ...data, subscription: sub };

      if(countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      handledExpiredForThisSession = false;

      if(active){
        const expiresAt = sub.expiresAt;
        const expiresMs = (expiresAt && typeof expiresAt.toMillis === 'function') ? expiresAt.toMillis() : (new Date(expiresAt).getTime());
        startSubscriptionCountdown(expiresMs);
        if (learningItem) learningItem.classList.remove('locked');
        if (learningOverlay) learningOverlay.style.display='none';
      } else {
        if (learningItem) learningItem.classList.add('locked');
        if (learningOverlay) learningOverlay.style.display='flex';
        if (subStatus) subStatus.innerText = 'غير مشترك';
      }
    }

    // learning button click -> SHOW MODAL (login required)
    if (learningEnterBtn) {
      learningEnterBtn.addEventListener('click', () => {
        if(!currentUser) {
          window.location.href = 'index.html';
          return;
        }
        showModal();
      });

      learningEnterBtn.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
          e.preventDefault();
          learningEnterBtn.click();
        }
      });
    }

    // auth state listener
    auth.onAuthStateChanged(user => {
      currentUser = user;
      if(!user) {
        if(balanceSpan) balanceSpan.innerText = '0';
        if(subStatus) subStatus.innerText = 'غير مسجل';
        if(userDocUnsub) userDocUnsub(); userDocUnsub = null;
        return;
      }
      const userRef = db.collection('users').doc(user.uid);
      if(userDocUnsub) userDocUnsub(); // remove old
      userDocUnsub = userRef.onSnapshot(doc => {
        if(!doc.exists) {
          userRef.set({ balance: 0, subscription: { active: false }, createdAt: firebase.firestore.FieldValue.serverTimestamp() })
            .catch(e => console.error('Error creating default user doc:', e));
          updateUIFromUserData({ balance:0, subscription:{active:false} });
          return;
        }
        updateUIFromUserData(doc.data());
      }, err => {
        console.error('snapshot error', err);
      });
    });

    // Start button scroll
    const startBtn = document.getElementById('startBtn');
    if (startBtn) startBtn.addEventListener('click',()=>{ const c = document.querySelector('.content'); if(c) c.scrollIntoView({behavior:'smooth'}); });

    // ensure modal hidden on load
    if (modalBackdrop) { modalBackdrop.style.display = 'none'; modalBackdrop.setAttribute('aria-hidden','true'); }

    // close modal on backdrop click
    if (modalBackdrop) modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

    // ---------- Countdown logic ----------
    function startSubscriptionCountdown(expiresMs) {
      function update() {
        const now = Date.now();
        let diff = expiresMs - now;
        if(diff <= 0) {
          if (subStatus) subStatus.innerText = 'انتهى الاشتراك';
          if (learningItem) { learningItem.classList.add('locked'); }
          if (learningOverlay) { learningOverlay.style.display='flex'; }
          if(currentUser && !handledExpiredForThisSession) {
            handledExpiredForThisSession = true;
            const userRef = db.collection('users').doc(currentUser.uid);
            userRef.get().then(doc => {
              if(!doc.exists) return;
              const data = doc.data();
              const sub = data.subscription;
              if(sub && sub.active === true) {
                userRef.update({ 'subscription.active': false }).catch(err => console.error('Error setting inactive after expiry:', err));
              }
            }).catch(err => console.error(err));
          }
          if(countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
          }
          return;
        }

        const days = Math.floor(diff / (24*60*60*1000));
        diff -= days * 24*60*60*1000;
        const hours = Math.floor(diff / (60*60*1000));
        diff -= hours * 60*60*1000;
        const mins = Math.floor(diff / (60*1000));
        diff -= mins * 60*1000;
        const secs = Math.floor(diff / 1000);

        const daysLabel = days > 0 ? `${days} يوم` : '';
        const timeLabel = `${pad(hours)}:${pad(mins)}:${pad(secs)}`;
        if (subStatus) subStatus.innerText = (`مفعل — باقي ${daysLabel} ${timeLabel}`).trim();
      }

      update();
      countdownInterval = setInterval(update, 1000);
    }

    function pad(n){ return n.toString().padStart(2,'0'); }

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if(userDocUnsub) userDocUnsub();
      if(countdownInterval) clearInterval(countdownInterval);
    });

    // small anims for stats (guarded so no errors)
    function animateCount(el,to){
      if(!el) return;
      let cur = 0; const step = Math.max(1, Math.floor(to/60));
      const id = setInterval(()=>{ cur+=step; if(cur>=to){ cur=to; el.textContent = '+'+to.toLocaleString(); clearInterval(id); } else el.textContent = '+'+cur.toLocaleString(); }, 14);
    }

    // reveal body after load to show nice fade-in
    window.addEventListener('load', ()=>{ document.body.classList.add('show'); });

    // small defensive log to confirm script ready
    console.info('StudyWeb main script loaded — optimized build (no console errors expected).');
  </script>
</body>
</html>
