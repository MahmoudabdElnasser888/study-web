<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Main Page</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --color1: #ff6f61;
  --color2: #6a11cb;
  --color3: #2575fc;
  --text-color: white;
}

/* ===== Body ===== */
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background: linear-gradient(270deg, var(--color1), var(--color2), var(--color3));
  background-size: 600% 600%;
  animation: gradientBG 15s ease infinite;
  color: var(--text-color);
  scroll-behavior: smooth;
}
@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* ===== Header ===== */
header { 
  width: 97.1%; 
  background-color: #000000c0; 
  padding: 15px 30px; 
  position: sticky; 
  top: 0; 
  z-index: 1000; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.4); 
  border-bottom: 2px solid #ff6f61; 
}

/* Ø§Ù„Ø±ØµÙŠØ¯ */
.rased {
  color: #fff;
  font-weight: bold;
  background: linear-gradient(120deg, #ff6f61, #ff3b2e);
  border-radius: 30px;
  padding: 6px 14px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.3);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  cursor: pointer;
  font-size: 15px;
  text-decoration: none;
}
.rased:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}

/* ÙŠÙ…ÙŠÙ† Ø§Ù„Ù‡ÙŠØ¯Ø± */
.header-right {
  display: flex;
  align-items: center;
  gap: 20px;
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ */
#subscription-status {
  font-weight: 600;
  font-size: 15px;
  color: #f9f9f9;
  background: rgba(0,0,0,0.25);
  padding: 6px 12px;
  border-radius: 8px;
  min-width: 220px;
  text-align: center;
}

/* Ø²Ø±Ø§Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ… */
.theme-toggle {
  background: #fff;
  color: #2575fc;
  border: none;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
  transition: all 0.25s ease;
}
.theme-toggle:hover {
  transform: rotate(15deg) scale(1.1);
  background: #f0f0f0;
}

/* ===== Hero Section ===== */
.hero{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:100vh;
  text-align:center;
  gap:20px;
}
.start-btn{
  background: var(--color1);
  border:none;
  padding: 20px 50px;
  border-radius: 15px;
  font-size:24px;
  font-weight:700;
  cursor:pointer;
  color:white;
  transition: transform 0.2s, background 0.3s;
}
.start-btn:hover{ transform:scale(1.05); background:#ff3b2e; }

/* ===== Content ===== */
.content{
  display:flex;
  flex-direction:column;
  gap:50px;
  padding:50px 20px;
}
.section-item{
  display:flex;
  align-items:center;
  gap:20px;
  background: rgba(255,255,255,0.1);
  padding:20px 30px;
  border-radius:15px;
  transition: transform 0.3s, box-shadow 0.3s;
  position: relative;
}
.section-item:hover{
  transform: translateY(-10px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
}
.section-item i{
  font-size:50px;
  color:goldenrod;
  min-width:60px;
  text-align:center;
}
.section-item div{ flex:1; }
.section-item h2{ margin-top:100px; }
.section-item p{ font-size:16px; margin-bottom:10px; }

.enter-btn{
  padding:10px 25px;
  border:none;
  border-radius:10px;
  background:#6a11cb;
  color:white;
  font-weight:600;
  cursor:pointer;
  transition: transform 0.2s, background 0.3s;
}
.enter-btn:hover{
  transform:scale(1.05);
  background:#2575fc;
}

/* locked state */
.section-item.locked {
  opacity: 0.85;
  filter: saturate(0.9);
}
.lock-overlay {
  position:absolute;
  right:20px;
  top:20px;
  background:rgba(0,0,0,0.6);
  padding:6px 100px 0px;
  border-radius:8px;
  display:flex;
  gap:8px;
  align-items:center;
  font-weight:600;
  color:#fff;
  width: auto;
}
  .lock-overlay i {
  font-size: 23px; /* Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙ‚Ø· */
  padding-bottom: 10px;
}
  


/* SOON tag */
.soon-tag {
  display: inline-block;
  background: #ff6f61;
  color: white;
  font-weight: 700;
  padding: 6px 14px;
  border-radius: 20px;
  margin-top: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); opacity: 0.9; }
  50% { transform: scale(1.08); opacity: 1; }
  100% { transform: scale(1); opacity: 0.9; }
}

/* ===== Footer ===== */
footer {
  background: #1a1a1a;
  padding: 15px 0;
  text-align: center;
  color: white;
  position: relative;
  width: 102%;
}

.social-links {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 10px;
}

.social-icon {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  color: white;
  font-size: 18px;
  text-decoration: none;
  transition: transform 0.3s ease, background-color 0.3s ease;
}

.social-icon.telegram { background-color: #0088cc; }
.social-icon.facebook { background-color: #1877f2; }
.social-icon.whatsapp { background-color: #25d366; }

.social-icon:hover {
  transform: translateY(-5px) scale(1.1);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.hidden-link {
  position: absolute;
  right: 15px;
  bottom: 10px;
  font-size: 12px;
  color: rgba(255,255,255,0.5);
  text-decoration: none;
}

.hidden-link:hover {
  color: white;
}



.hidden-link {
  font-size: 10px;
  color: rgba(255, 255, 255, 0.37);
  padding-left: 16px;
}

/* ===== Modal ===== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
.modal {
  width: 95%;
  max-width: 520px;
  background: linear-gradient(180deg,#fff,#f7f7f7);
  color: #111;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}
.modal h3 { margin-top: 0; }
.package {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  padding:12px;
  border-radius:8px;
  border:2px solid #eee;
  margin-bottom:10px;
  cursor:pointer;
}
.package.selected { border-color:#6a11cb; box-shadow:0 8px 20px rgba(106,17,203,0.08); background:#fff; }
.modal-footer { display:flex; justify-content:space-between; gap:12px; margin-top:16px; }
.btn { padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer; border: none; }
.btn.primary { background: #6a11cb; color:white; }
.btn.ghost { background: transparent; border: 2px solid #ccc; }

/* ===== Media Queries ===== */
@media (max-width: 768px){
  .content {
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 20px 10px;
    gap: 20px;
  }

  .content > * {
    width: 100%;
    max-width: 400px;
  }

  .start-btn {
    padding: 12px 30px;
    font-size: 18px;
  }

  .hero {
    height: auto;
    min-height: 70vh;
    padding: 20px 0;
  }
  /* ğŸ”» Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙˆØªØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙÙ‚Ø· */
 footer {
    width: 111.4%;
    max-width: 500px; /* ğŸ‘ˆ Ù‡Ù†Ø§ Ø¨ØªØ­Ø¯Ø¯ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ø¹Ø§ÙŠØ²Ù‡ */
    margin: 0 auto;   /* Ø¹Ø´Ø§Ù† ÙŠÙØ¶Ù„ ÙÙŠ Ø§Ù„Ù†Øµ */
  }
}

.priv {
  font-size: 17px;
  text-decoration: none;
  color: #ccc;
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 16px;
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.05);
  box-shadow: 0px 3px 8px rgba(209, 17, 17, 0.6);
  transition: all 0.6s ease;
  backdrop-filter: blur(5px);
}

.priv:hover {
  transform: translateY(-3px) scale(1.05);
  color: #fff;
  background: linear-gradient(135deg, #c33, #ff5555);
  box-shadow: 0px 4px 12px rgba(195, 51, 51, 0.8);
}



</style>

</head>
<body>

<header>
  <div class="header-right">
    <a href="pay.html" class="rased"> Ø§Ù„Ø±ØµÙŠØ¯: <span id="balance">0</span> Ø¬ </a>
    <div id="subscription-status"></div>
    <a href="privacy.html" class="priv"> privacy policy</a>
  </div>
</header>

<section class="hero">
  <h1>Welcome to Your Study Platform</h1>
  <button class="start-btn">START</button>
</section>

<section class="content">

  <!-- To Do List -->
  <div id="todo" class="section-item">
    <i class="fas fa-list-check"></i>
    <div>
      <h2>To Do List</h2>
      <p>Organize your daily tasks efficiently.</p>
      <a href="to-do.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <!-- Quiz -->
  <div id="quiz" class="section-item">
    <i class="fas fa-question-circle"></i>
    <div>
      <h2>Quiz</h2>
      <p>Test your knowledge with quizzes.</p>
      <a href="quiz1-start.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <!-- Learning (this one locked until subscription) -->
  <div id="learning" class="section-item locked">
    <i class="fas fa-book"></i>
    <div>
      <h2>Learning Content</h2>
      <p>Access lessons and tutorials.</p>
      <!-- NOTE: this button now always opens the modal (instead of redirecting directly) -->
      <button id="learning-enter" class="enter-btn">ENTER</button>
    </div>
    <div class="lock-overlay" id="learning-overlay"><i class="fas fa-lock"></i> Ù…ÙÙ‚ÙÙ„ â€” Ø§Ø´ØªØ±Ùƒ</div>
  </div>

  <!-- Timer -->
  <div id="timer" class="section-item">
    <i class="fas fa-stopwatch"></i>
    <div>
      <h2>Study Timer</h2>
      <p>Track your study sessions effectively.</p>
      <a href="timer.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <!-- Community -->
  <div id="community" class="section-item">
    <i class="fas fa-users"></i>
    <div>
      <h2>Community</h2>
      <p>Join discussions and connect with others.</p>
      <a href="community.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <!-- Note -->
  <div id="note" class="section-item">
    <i class="fas fa-sticky-note"></i>
    <div>
      <h2>Note</h2>
      <p>Write and save your important notes.</p>
      <a href="note.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <!-- Top 3 -->
  <div id="top3" class="section-item">
    <i class="fa-solid fa-trophy"></i>
    <div>
      <h2>TOP 3</h2>
      <p>Be the best.</p>
      <a href="dash.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <!-- Feedback box -->
  <div id="feedback" class="section-item">
    <i class="fa-solid fa-box"></i>
    <div>
      <h2>Feedback box</h2>
      <p>Send us your feedback</p>
      <a href="feedback.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <!-- Championship -->
  <div id="championship" class="section-item locked">
    <i class="fa-solid fa-trophy"></i>
    <div>
      <h2>Championship</h2>
      <p>Ø§Ù†Ø¶Ù… Ù„Ù„Ø¨Ø·ÙˆÙ„Ø© ÙˆÙ†Ø§ÙØ³ Ø²Ù…Ù„Ø§Ø¡Ùƒ</p>
      <a href="rules.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <!-- Summarization -->
  <div id="summarization" class="section-item">
    <i class="fas fa-file-alt"></i>
    <div>
      <h2>Summarization</h2>
      <p>Send and manage summaries.</p>
      <a href="try.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

  <div id="summarization" class="section-item">
    <i class="fa-solid fa-money-check-dollar"></i>
    <div>
      <h2>Get your Prize</h2>
      <a href="prize.html"><button class="enter-btn">ENTER</button></a>
    </div>
  </div>

 <!-- HTML -->
<div id="summarization" class="section-item locked">
  <div class="lock-overlay">
 
    <span>SOON</span>
  </div>
 <i class="fa-solid fa-bag-shopping"></i>
  <div>
    <h2>Our Brand</h2>
    <p>Coming Soon....ğŸ¤«</p>
    <button disabled>Locked</button>
  </div>
</div>



<div id="summarization" class="section-item locked">
  <div class="lock-overlay">
 
    <span>SOON</span>
  </div>
  <i class="fa-solid fa-handshake-angle"></i>
  <div>
    <h2>Upcoming deals</h2>
    <p>Coming Soon....ğŸ¤«</p>
    <button disabled>Locked</button>
  </div>
</div>






</section>



<footer>
  <div class="social-links">
    <a href="https://t.me/studyweb1919" target="_blank" class="social-icon telegram">
      <i class="fab fa-telegram"></i>
    </a>
    <a href="https://www.facebook.com/YourPage" target="_blank" class="social-icon facebook">
      <i class="fab fa-facebook-f"></i>
    </a>
    <a href="https://wa.me/201121101238" target="_blank" class="social-icon whatsapp">
      <i class="fab fa-whatsapp"></i>
    </a>
  </div>

  <a href="the-admin.html" target="_blank" class="hidden-link">404</a>
</footer>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


<!-- Modal (subscription) -->
<div class="modal-backdrop" id="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <h3 id="modal-title">Ø§Ø´ØªØ±Ùƒ ÙÙŠ Learning Content</h3>
    <p class="info-line">Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© â€” Ø§Ù„Ø¯ÙØ¹ ÙŠØªÙ… Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚).</p>

    <!-- 3 packages -->
    <div id="packageList">
      <div class="package" data-amount="20" data-days="7" id="pkg20">
        <div>
          <strong>Ø¨Ø§Ù‚Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠ</strong>
          <div style="font-size:13px;color:#666;margin-top:6px;">ØµÙ„Ø§Ø­ÙŠØ©: 7 Ø£ÙŠØ§Ù…</div>
        </div>
        <div style="font-weight:800; color:#6a11cb;">20 Ø¬</div>
      </div>

      <div class="package" data-amount="35" data-days="14" id="pkg35">
        <div>
          <strong>Ø¨Ø§Ù‚Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†</strong>
          <div style="font-size:13px;color:#666;margin-top:6px;">ØµÙ„Ø§Ø­ÙŠØ©: 14 ÙŠÙˆÙ…</div>
        </div>
        <div style="font-weight:800; color:#6a11cb;">35 Ø¬</div>
      </div>

      <div class="package" data-amount="50" data-days="30" id="pkg50">
        <div>
          <strong>Ø¨Ø§Ù‚Ø© Ø´Ù‡Ø±</strong>
          <div style="font-size:13px;color:#666;margin-top:6px;">ØµÙ„Ø§Ø­ÙŠØ©: 30 ÙŠÙˆÙ…</div>
        </div>
        <div style="font-weight:800; color:#6a11cb;">50 Ø¬</div>
      </div>
    </div>

    <div id="modal-msg" class="info-line" style="color:#c33;"></div>

    <div class="modal-footer">
      <button class="btn ghost" id="modal-cancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn primary" id="modal-confirm">Ø§Ø¯ÙØ¹</button>
    </div>
  </div>
</div>

<!-- Firebase (v8 to match your existing setup) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  // ---------- Firebase config (yours) ----------
  const firebaseConfig = { 
    apiKey: "AIzaSyDnXtTg9iLLm_b9zyKBxr0v8aGhXJuR3WE",
    authDomain: "my-web-c23de.firebaseapp.com",
    projectId: "my-web-c23de",
    storageBucket: "my-web-c23de.appspot.com",
    messagingSenderId: "846339445873",
    appId: "1:846339445873:web:fc0427a7ad77eceda837d0",
    measurementId: "G-3SE0GBRS8C"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------- UI refs ----------
  const balanceSpan = document.getElementById('balance');
  const subStatus = document.getElementById('subscription-status');
  const learningItem = document.getElementById('learning');
  const learningEnterBtn = document.getElementById('learning-enter');
  const learningOverlay = document.getElementById('learning-overlay');

  const modalBackdrop = document.getElementById('modal-backdrop');
  const packageList = document.getElementById('packageList');
  const modalMsg = document.getElementById('modal-msg');
  const modalConfirm = document.getElementById('modal-confirm');
  const modalCancel = document.getElementById('modal-cancel');

  let currentUser = null;
  let selectedPackageAmount = null;
  let selectedPackageDays = null;
  let userDocUnsub = null;
  let localUserData = {};
  let countdownInterval = null;
  let handledExpiredForThisSession = false;
  let modalMode = 'purchase'; // 'purchase' or 'goto' (when subscription active)

  // helper: compute remaining time parts
  function getRemainingParts(expiresMs){
    const now = Date.now();
    let diff = Math.max(0, expiresMs - now);
    const days = Math.floor(diff / (24*60*60*1000)); diff -= days * 24*60*60*1000;
    const hours = Math.floor(diff / (60*60*1000)); diff -= hours * 60*60*1000;
    const mins = Math.floor(diff / (60*1000)); diff -= mins * 60*1000;
    const secs = Math.floor(diff / 1000);
    return { days, hours, mins, secs };
  }

  // show modal (mode depends on subscription status)
  function showModal() {
    modalMsg.innerText = '';
    selectedPackageAmount = null;
    selectedPackageDays = null;
    modalConfirm.disabled = false;
    document.querySelectorAll('.package').forEach(el => el.classList.remove('selected'));

    // decide mode based on localUserData.subscription
    const sub = localUserData.subscription;
    const hasActive = sub && sub.active === true && sub.expiresAt;
    let stillActive = false;
    if(hasActive){
      // compute expiresMs reliably (Firestore Timestamp or ISO)
      const expiresAt = sub.expiresAt;
      const expiresMs = (expiresAt && expiresAt.toMillis) ? expiresAt.toMillis() : (new Date(expiresAt).getTime());
      if(!isNaN(expiresMs) && expiresMs > Date.now()) stillActive = true;
    }

    if(stillActive){
      // show goto mode
      modalMode = 'goto';
      packageList.style.display = 'none';
      // show remaining time
      const expiresAt = sub.expiresAt;
      const expiresMs = (expiresAt && expiresAt.toMillis) ? expiresAt.toMillis() : (new Date(expiresAt).getTime());
      const rem = getRemainingParts(expiresMs);
      modalMsg.style.color = '#0a7b2a';
      modalMsg.innerText = `Ø§Ø´ØªØ±Ø§Ùƒ Ù…ÙØ¹Ù„ â€” Ø¨Ø§Ù‚ÙŠ ${rem.days} ÙŠÙˆÙ… ${pad(rem.hours)}:${pad(rem.mins)}:${pad(rem.secs)}. Ø§Ø¶ØºØ· "Ø§Ø°Ù‡Ø¨ Ù„Ù„Ù…Ø­ØªÙˆÙ‰" Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„.`;
      modalConfirm.innerText = 'Ø§Ø°Ù‡Ø¨ Ù„Ù„Ù…Ø­ØªÙˆÙ‰';
    } else {
      // show purchase packages
      modalMode = 'purchase';
      packageList.style.display = 'block';
      modalMsg.style.color = '#c33';
      modalMsg.innerText = '';
      modalConfirm.innerText = 'Ø§Ø¯ÙØ¹';
    }

    modalBackdrop.style.display = 'flex';
  }
  function closeModal() { 
    modalBackdrop.style.display = 'none'; 
    packageList.style.display = 'block'; 
    modalMsg.innerText = '';
  }

  // select package (single)
  packageList.addEventListener('click', (e) => {
    const pkg = e.target.closest('.package');
    if(!pkg) return;
    document.querySelectorAll('.package').forEach(el => el.classList.remove('selected'));
    pkg.classList.add('selected');
    selectedPackageAmount = Number(pkg.dataset.amount);
    selectedPackageDays = Number(pkg.dataset.days);
    modalMsg.style.color = '#333';
    modalMsg.innerText = `Ø³ÙŠØªÙ… Ø®ØµÙ… ${selectedPackageAmount} Ø¬ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯. ØµÙ„Ø§Ø­ÙŠØ©: ${selectedPackageDays} ÙŠÙˆÙ….`;
    modalConfirm.innerText = `Ø§Ø¯ÙØ¹ ${selectedPackageAmount} Ø¬`;
  });

  modalCancel.addEventListener('click', () => { closeModal(); });

  // confirm purchase or goto content
  modalConfirm.addEventListener('click', async () => {
    if(modalMode === 'goto') {
      // go to content
      closeModal();
      window.location.href = 'student.html';
      return;
    }

    // otherwise purchase flow
    if(!currentUser) {
      modalMsg.style.color = 'red';
      modalMsg.innerText = 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.';
      return;
    }
    if(!selectedPackageAmount || !selectedPackageDays) {
      modalMsg.style.color = 'red';
      modalMsg.innerText = 'Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹.';
      return;
    }

    modalConfirm.disabled = true;
    modalConfirm.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

    const uid = currentUser.uid;
    const userRef = db.collection('users').doc(uid);

    try {
      await db.runTransaction(async (tran) => {
        const doc = await tran.get(userRef);
        if(!doc.exists) throw new Error('Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
        const data = doc.data();
        const balance = Number(data.balance ?? 0);
        if(balance < selectedPackageAmount) throw new Error('Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ');

        // Ø­Ø³Ø§Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø¹ ØªØ¹ÙˆÙŠØ¶ Ø¨Ø³ÙŠØ·)
        const nowMs = Date.now();
        const expiresAtMs = nowMs + selectedPackageDays * 24 * 60 * 60 * 1000;
        const startsAtTs = firebase.firestore.Timestamp.fromMillis(nowMs);
        const expiresAtTs = firebase.firestore.Timestamp.fromMillis(expiresAtMs);

        const newBalance = balance - selectedPackageAmount;

        tran.update(userRef, {
          balance: newBalance,
          subscription: {
            active: true,
            boughtAt: startsAtTs,
            expiresAt: expiresAtTs,
            packageAmount: selectedPackageAmount,
            days: selectedPackageDays
          }
        });
      });

      modalMsg.style.color = '#0a7b2a';
      modalMsg.innerText = 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ â€” ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰.';
      // Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
      setTimeout(() => { closeModal(); }, 900);

    } catch (err) {
      console.error(err);
      modalMsg.style.color = 'red';
      modalMsg.innerText = 'Ø­ØµÙ„ Ø®Ø·Ø£: ' + (err.message || err);
    } finally {
      modalConfirm.disabled = false;
      modalConfirm.innerText = `Ø§Ø¯ÙØ¹ ${selectedPackageAmount ? selectedPackageAmount + ' Ø¬' : ''}`.trim() || 'Ø§Ø¯ÙØ¹';
    }
  });

  // update UI from user doc
  function updateUIFromUserData(data) {
    const balance = Number(data.balance ?? 0);
    balanceSpan.innerText = Math.max(0, balance);

    const sub = data.subscription;
    const active = sub && sub.active === true && sub.expiresAt;

    localUserData = { ...data, subscription: sub };

    // stop previous countdown
    if(countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    handledExpiredForThisSession = false;

    if(active){
      // compute remaining
      const expiresAt = sub.expiresAt;
      const expiresMs = (expiresAt && expiresAt.toMillis) ? expiresAt.toMillis() : (new Date(expiresAt).getTime());
      startSubscriptionCountdown(expiresMs);
      learningItem.classList.remove('locked');
      learningOverlay.style.display='none';
    } else {
      learningItem.classList.add('locked');
      learningOverlay.style.display='flex';
      subStatus.innerText = `ØºÙŠØ± Ù…Ø´ØªØ±Ùƒ`;
    }
  }

  // learning button click -> SHOW MODAL (always) (login required)
  learningEnterBtn.addEventListener('click', () => {
    if(!currentUser) {
      // not logged in -> redirect to index/login
      window.location.href = 'index.html';
      return;
    }
    showModal();
  });

  // also support Enter key when the learning button is focused (browser normally triggers click on Enter for buttons,
  // but we add explicit handling to be safe)
  learningEnterBtn.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
      e.preventDefault();
      learningEnterBtn.click();
    }
  });

  // auth state listener
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if(!user) {
      // not logged in â€” keep page visible but prompt redirect on actions
      balanceSpan.innerText = '0';
      subStatus.innerText = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
      if(userDocUnsub) userDocUnsub(); userDocUnsub = null;
      return;
    }
    // subscribe to user's doc
    const userRef = db.collection('users').doc(user.uid);
    if(userDocUnsub) userDocUnsub(); // remove old
    userDocUnsub = userRef.onSnapshot(doc => {
      if(!doc.exists) {
        // create default doc
        userRef.set({ balance: 0, subscription: { active: false }, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        updateUIFromUserData({ balance:0, subscription:{active:false} });
        return;
      }
      updateUIFromUserData(doc.data());
    }, err => {
      console.error('snapshot error', err);
    });
  });

  // Start button scroll
  document.querySelector('.start-btn').addEventListener('click',()=>{ document.querySelector('.content').scrollIntoView({behavior:'smooth'}); });

  // Theme toggle
  const themeBtn = document.querySelector('.theme-toggle');
  themeBtn.addEventListener('click',()=>{
    document.body.classList.toggle('dark-theme');
    if(document.body.classList.contains('dark-theme')) localStorage.setItem('theme','dark');
    else localStorage.setItem('theme','light');
  });
  if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-theme');

  // ensure modal hidden on load
  modalBackdrop.style.display = 'none';

  // small safety: close modal on backdrop click
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

  // ---------- Countdown logic ----------
  function startSubscriptionCountdown(expiresMs) {
    function update() {
      const now = Date.now();
      let diff = expiresMs - now;
      if(diff <= 0) {
        subStatus.innerText = `Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ`;
        // lock content in UI
        learningItem.classList.add('locked');
        learningOverlay.style.display='flex';
        // mark subscription inactive in Firestore once (prevent multiple writes)
        if(currentUser && !handledExpiredForThisSession) {
          handledExpiredForThisSession = true;
          const userRef = db.collection('users').doc(currentUser.uid);
          // Update only if subscription still exists and expired
          userRef.get().then(doc => {
            if(!doc.exists) return;
            const data = doc.data();
            const sub = data.subscription;
            if(sub && sub.active === true) {
              // set active false
              userRef.update({ 'subscription.active': false }).catch(err => console.error('Error setting inactive after expiry:', err));
            }
          }).catch(err => console.error(err));
        }
        // clear interval
        if(countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        return;
      }
      // compute days/hours/minutes/seconds
      const days = Math.floor(diff / (24*60*60*1000));
      diff -= days * 24*60*60*1000;
      const hours = Math.floor(diff / (60*60*1000));
      diff -= hours * 60*60*1000;
      const mins = Math.floor(diff / (60*1000));
      diff -= mins * 60*1000;
      const secs = Math.floor(diff / 1000);

      // display: ÙƒØªØ§Ø¨ÙŠ Ø¹Ø±Ø¨ÙŠ
      const daysLabel = days > 0 ? `${days} ÙŠÙˆÙ…` : '';
      const timeLabel = `${pad(hours)}:${pad(mins)}:${pad(secs)}`;
      subStatus.innerText = `Ù…ÙØ¹Ù„ â€” Ø¨Ø§Ù‚ÙŠ ${daysLabel} ${timeLabel}`.trim();
    }

    // initial update + interval
    update();
    countdownInterval = setInterval(update, 1000);
  }

  function pad(n){ return n.toString().padStart(2,'0'); }

  // Clean up on page unload
  window.addEventListener('beforeunload', () => {
    if(userDocUnsub) userDocUnsub();
    if(countdownInterval) clearInterval(countdownInterval);
  });


</script>
</body>
</html>
