<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اختبار الرياضيات</title>
  <style>
    body {
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #333;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      max-width: 850px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      animation: fadeIn 1s ease;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #4b3cc4;
    }
    .question {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
    }
    .option {
      display: block;
      margin: 6px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    .option:hover { background: #eef; }
    .option.correct { background: #c8f7c5; border-color: #28a745; }
    .option.wrong { background: #f7c5c5; border-color: #dc3545; }
    #timer {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #555;
      margin-bottom: 15px;
    }
    .result {
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
      font-size: 18px;
    }
    img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .button {
      display: block;
      margin: 10px auto;
      background: linear-gradient(120deg, #5a67d8, #805ad5);
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 25px;
      cursor: pointer;
      transition: 0.3s;
    }
    .button:hover { opacity: 0.9; }
  </style>
</head>
<body>
<div class="container" id="container">
  <h2 id="welcome">جاري البحث عن حسابك...</h2>
  <div id="quizBox" style="display:none;">
    <div id="timer">الوقت المتبقي: 10:00</div>

    <div class="question" data-correct="2">
      <img src="q1.jpg" alt="سؤال 1">
      <label class="option"><input type="radio" name="q1" value="1"> أ</label>
      <label class="option"><input type="radio" name="q1" value="2"> ب</label>
      <label class="option"><input type="radio" name="q1" value="3"> ج</label>
      <label class="option"><input type="radio" name="q1" value="4"> د</label>
    </div>

    <div class="question" data-correct="3">
      <img src="q2.jpg" alt="سؤال 2">
      <label class="option"><input type="radio" name="q2" value="1"> أ</label>
      <label class="option"><input type="radio" name="q2" value="2"> ب</label>
      <label class="option"><input type="radio" name="q2" value="3"> ج</label>
      <label class="option"><input type="radio" name="q2" value="4"> د</label>
    </div>

    <button class="button" id="showAnswers">إنهاء وإرسال النتيجة</button>
    <div class="result" id="result"></div>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDnXtTg9iLLm_b9zyKBxr0v8aGhXJuR3WE",
    authDomain: "my-web-c23de.firebaseapp.com",
    projectId: "my-web-c23de",
    storageBucket: "my-web-c23de.firebasestorage.app",
    messagingSenderId: "846339445873",
    appId: "1:846339445873:web:fc0427a7ad77eceda837d0",
    measurementId: "G-3SE0GBRS8C"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const SUBJECT_NAME = "اختبار الرياضيات";
  const QUIZ_TIME = 10 * 60; // 10 دقائق
  let timer;
  let totalSeconds = QUIZ_TIME;
  let userEmail = "";
  let userId = "";

  const welcome = document.getElementById("welcome");
  const quizBox = document.getElementById("quizBox");
  const resultDiv = document.getElementById("result");
  const timerDiv = document.getElementById("timer");

  // تسجيل الدخول تلقائيًا (بالحساب الحالي)
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      userEmail = user.email;
      userId = user.uid;
      welcome.innerText = `مرحبًا ${user.displayName || ""}!`;
      setTimeout(() => {
        welcome.style.display = "none";
        quizBox.style.display = "block";
        startTimer();
      }, 1500);
    } else {
      welcome.innerText = "الرجاء تسجيل الدخول أولاً 🔒";
    }
  });

  function startTimer() {
    timer = setInterval(() => {
      let min = Math.floor(totalSeconds / 60);
      let sec = totalSeconds % 60;
      timerDiv.textContent = `الوقت المتبقي: ${min}:${sec.toString().padStart(2, '0')}`;
      if (totalSeconds <= 0) {
        clearInterval(timer);
        showResults();
      }
      totalSeconds--;
    }, 1000);
  }

  async function showResults() {
    clearInterval(timer);
    let correctCount = 0;
    const questions = document.querySelectorAll(".question");

    questions.forEach((q, index) => {
      const correct = parseInt(q.dataset.correct);
      const selected = q.querySelector(`input[name="q${index + 1}"]:checked`);
      q.querySelectorAll(".option").forEach(opt => {
        const val = parseInt(opt.querySelector("input").value);
        if (val === correct) opt.classList.add("correct");
        if (selected && parseInt(selected.value) === val && val !== correct) opt.classList.add("wrong");
      });
      if (selected && parseInt(selected.value) === correct) correctCount++;
    });

    resultDiv.innerText = `درجتك: ${correctCount} من ${questions.length}`;

    // حفظ النتيجة في Firestore
    try {
      const resultRef = db.collection("results");
      await resultRef.add({
        uid: userId,
        email: userEmail,
        subject: SUBJECT_NAME,
        score: correctCount,
        total: questions.length,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // تحديث مجموع المستخدم
      const userRef = db.collection("users").doc(userId);
      await db.runTransaction(async (t) => {
        const userDoc = await t.get(userRef);
        const currentScore = userDoc.exists && userDoc.data().score ? userDoc.data().score : 0;
        t.update(userRef, { score: currentScore + correctCount });
      });

      alert("✅ تم إرسال النتيجة وتحديث مجموعك!");
    } catch (err) {
      console.error(err);
      alert("⚠️ فشل أثناء الإرسال: " + err.message);
    }
  }

  document.getElementById("showAnswers").addEventListener("click", showResults);
</script>
</body>
</html>
